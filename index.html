<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>動画音声抽出ツール</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ffmpeg/0.12.7/umd/ffmpeg.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            background: #f0f2ff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #e8ebff;
            border-color: #5a67d8;
        }

        #fileInput {
            display: none;
        }

        .upload-text {
            color: #666;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .file-info {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
            align-items: center;
        }

        select, button {
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 16px;
        }

        select {
            background: white;
            min-width: 120px;
        }

        button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            border: none;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .progress-container {
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            color: #666;
        }

        .log-container {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 20px 0;
            display: none;
        }

        .result-container {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }

        .download-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            padding: 12px 24px;
            text-decoration: none;
            color: white;
            border-radius: 6px;
            display: inline-block;
            margin-top: 10px;
            font-weight: bold;
        }

        .error {
            background: #ffe6e6;
            color: #d63031;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #fab1a0;
            display: none;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-box {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎵 動画音声抽出ツール</h1>
        
        <div class="info-box">
            <strong>対応形式：</strong> MP4, WebM, AVI, MOV, MKV など<br>
            <strong>出力形式：</strong> MP3, WAV, AAC, OGG
        </div>

        <div class="upload-area" id="uploadArea">
            <div class="upload-text">
                <strong>動画ファイルを選択またはドラッグ＆ドロップ</strong><br>
                クリックしてファイルを選択
            </div>
            <input type="file" id="fileInput" accept="video/*">
        </div>

        <div class="file-info" id="fileInfo">
            <strong>選択されたファイル:</strong> <span id="fileName"></span><br>
            <strong>サイズ:</strong> <span id="fileSize"></span>
        </div>

        <div class="controls">
            <label for="outputFormat">出力形式:</label>
            <select id="outputFormat">
                <option value="mp3">MP3</option>
                <option value="wav">WAV</option>
                <option value="aac">AAC</option>
                <option value="ogg">OGG</option>
            </select>
            
            <button id="extractBtn" disabled>
                音声を抽出
            </button>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">準備中...</div>
        </div>

        <div class="error" id="errorDiv"></div>

        <div class="log-container" id="logContainer"></div>

        <div class="result-container" id="resultContainer">
            <h3>✅ 抽出完了！</h3>
            <p>音声ファイルが正常に抽出されました。</p>
            <a id="downloadLink" class="download-btn" download>📥 ダウンロード</a>
        </div>
    </div>

    <script>
        const { FFmpeg } = FFmpegWASM;
        
        let ffmpeg;
        let selectedFile = null;

        // DOM要素の取得
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const extractBtn = document.getElementById('extractBtn');
        const outputFormat = document.getElementById('outputFormat');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const logContainer = document.getElementById('logContainer');
        const errorDiv = document.getElementById('errorDiv');
        const resultContainer = document.getElementById('resultContainer');
        const downloadLink = document.getElementById('downloadLink');

        // FFmpegの初期化
        async function initFFmpeg() {
            try {
                ffmpeg = new FFmpeg();
                
                ffmpeg.on('log', ({ message }) => {
                    console.log(message);
                    logContainer.textContent += message + '\n';
                    logContainer.scrollTop = logContainer.scrollHeight;
                });

                ffmpeg.on('progress', ({ progress, time }) => {
                    const percentage = Math.round(progress * 100);
                    progressFill.style.width = percentage + '%';
                    progressText.textContent = `処理中... ${percentage}% (${time}s)`;
                });

                showProgress('FFmpegを初期化中...');
                await ffmpeg.load();
                hideProgress();
                
                console.log('FFmpeg loaded successfully');
            } catch (error) {
                console.error('FFmpeg initialization failed:', error);
                showError('FFmpegの初期化に失敗しました: ' + error.message);
                hideProgress();
            }
        }

        // ファイル選択処理
        uploadArea.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', handleFileSelect);

        // ドラッグ＆ドロップ処理
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect({ target: { files } });
            }
        });

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            selectedFile = file;
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.style.display = 'block';
            extractBtn.disabled = false;
            
            hideError();
            hideResult();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 音声抽出処理
        extractBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            try {
                extractBtn.disabled = true;
                extractBtn.innerHTML = '<span class="loading"></span>音声抽出中...';
                
                showProgress('ファイルを読み込み中...');
                logContainer.style.display = 'block';
                logContainer.textContent = '';
                hideError();
                hideResult();

                // FFmpegが初期化されていない場合は初期化
                if (!ffmpeg) {
                    await initFFmpeg();
                }

                // ファイルをFFmpegに読み込み
                const inputFileName = 'input.' + selectedFile.name.split('.').pop();
                const outputFileName = 'output.' + outputFormat.value;
                
                await ffmpeg.writeFile(inputFileName, await fetchFile(selectedFile));

                progressText.textContent = '音声抽出中...';

                // 音声抽出コマンドの実行
                let command;
                switch(outputFormat.value) {
                    case 'mp3':
                        command = ['-i', inputFileName, '-vn', '-acodec', 'libmp3lame', '-ab', '192k', outputFileName];
                        break;
                    case 'wav':
                        command = ['-i', inputFileName, '-vn', '-acodec', 'pcm_s16le', outputFileName];
                        break;
                    case 'aac':
                        command = ['-i', inputFileName, '-vn', '-acodec', 'aac', '-ab', '192k', outputFileName];
                        break;
                    case 'ogg':
                        command = ['-i', inputFileName, '-vn', '-acodec', 'libvorbis', '-ab', '192k', outputFileName];
                        break;
                    default:
                        command = ['-i', inputFileName, '-vn', '-acodec', 'libmp3lame', '-ab', '192k', outputFileName];
                }

                await ffmpeg.exec(command);

                // 結果ファイルの取得
                const data = await ffmpeg.readFile(outputFileName);
                
                // ダウンロードリンクの作成
                const blob = new Blob([data.buffer], { type: getContentType(outputFormat.value) });
                const url = URL.createObjectURL(blob);
                
                downloadLink.href = url;
                downloadLink.download = selectedFile.name.replace(/\.[^/.]+$/, "") + '.' + outputFormat.value;
                
                hideProgress();
                showResult();

                // クリーンアップ
                await ffmpeg.deleteFile(inputFileName);
                await ffmpeg.deleteFile(outputFileName);

            } catch (error) {
                console.error('Audio extraction failed:', error);
                showError('音声抽出に失敗しました: ' + error.message);
                hideProgress();
            } finally {
                extractBtn.disabled = false;
                extractBtn.textContent = '音声を抽出';
            }
        });

        function fetchFile(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(new Uint8Array(reader.result));
                reader.readAsArrayBuffer(file);
            });
        }

        function getContentType(format) {
            const types = {
                'mp3': 'audio/mpeg',
                'wav': 'audio/wav',
                'aac': 'audio/aac',
                'ogg': 'audio/ogg'
            };
            return types[format] || 'audio/mpeg';
        }

        function showProgress(message) {
            progressContainer.style.display = 'block';
            progressText.textContent = message;
            progressFill.style.width = '0%';
        }

        function hideProgress() {
            progressContainer.style.display = 'none';
        }

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            errorDiv.style.display = 'none';
        }

        function showResult() {
            resultContainer.style.display = 'block';
        }

        function hideResult() {
            resultContainer.style.display = 'none';
        }

        // ページ読み込み時にFFmpegを初期化
        window.addEventListener('load', () => {
            console.log('Initializing FFmpeg...');
            // 初期化は必要時に行うように変更（ファイル選択後）
        });
    </script>
</body>
</html>